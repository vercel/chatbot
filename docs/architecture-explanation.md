# AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œè§£èª¬

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã«åŸºã¥ã„ã¦ã€AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã©ã®ã‚ˆã†ã«å‹•ä½œã™ã‚‹ã‹ã‚’ã€åˆå­¦è€…ã®æ–¹ã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [å…¨ä½“æ§‹æˆã®æ¦‚è¦](#å…¨ä½“æ§‹æˆã®æ¦‚è¦)
2. [å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²](#å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²)
3. [ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®æµã‚Œï¼ˆè©³ç´°è§£èª¬ï¼‰](#ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®æµã‚Œè©³ç´°è§£èª¬)
4. [ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨ç®¡ç†](#ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨ç®¡ç†)
5. [Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã®é€£æº](#difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã®é€£æº)
6. [æŠ€è¡“çš„ãªè©³ç´°](#æŠ€è¡“çš„ãªè©³ç´°)

---

## å…¨ä½“æ§‹æˆã®æ¦‚è¦

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€å¤§ãã3ã¤ã®ä¸»è¦ãªéƒ¨åˆ†ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WEB APP (React) â”‚  â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ“ä½œã™ã‚‹ç”»é¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND (Next.js)â”‚  â† å‡¦ç†ã®ä¸­æ ¸éƒ¨åˆ†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ APIå‘¼ã³å‡ºã—
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXTERNAL SERVICESâ”‚  â† AIãƒ¢ãƒ‡ãƒ«ã‚„å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. **WEB APP (React)** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿéš›ã«æ“ä½œã™ã‚‹éƒ¨åˆ†ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã—ã¾ã™ã€‚

### 2. **BACKEND (Next.js)** - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
WEB APPã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã™ã‚‹ä¸­å¿ƒçš„ãªå½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚

### 3. **EXTERNAL SERVICES** - å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
AIãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚„Difyã‚µãƒ¼ãƒ“ã‚¹ãªã©ã€å°‚é–€çš„ãªæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

---

## å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²

### ğŸŒ WEB APP (React)

#### React Componentsï¼ˆReactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰

**Chatï¼ˆãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰**
- **å ´æ‰€**: `components/chat.tsx`
- **å½¹å‰²**: ãƒãƒ£ãƒƒãƒˆç”»é¢ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™
- **æ©Ÿèƒ½**:
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹
  - AIã‹ã‚‰ã®è¿”ä¿¡ã‚’è¡¨ç¤ºã™ã‚‹
  - ä¼šè©±å±¥æ­´ã‚’ç®¡ç†ã™ã‚‹
  - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›æ¬„ã‚’æä¾›ã™ã‚‹

**Multimodal Inputï¼ˆãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å…¥åŠ›ï¼‰**
- **å ´æ‰€**: `components/multimodal-input.tsx`
- **å½¹å‰²**: ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã§ãªãã€ç”»åƒã‚„éŸ³å£°ãªã©æ§˜ã€…ãªå½¢å¼ã§ã®å…¥åŠ›ã‚’å¯èƒ½ã«ã—ã¾ã™
- **æ©Ÿèƒ½**:
  - ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
  - ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  - éŸ³å£°å…¥åŠ›ï¼ˆå°†æ¥ã®æ‹¡å¼µï¼‰

#### useChat Hookï¼ˆuseChatãƒ•ãƒƒã‚¯ï¼‰

**å ´æ‰€**: `components/chat.tsx`å†…ã§ä½¿ç”¨

**å½¹å‰²**: ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®çŠ¶æ…‹ç®¡ç†ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®é€šä¿¡ã‚’ç°¡å˜ã«è¡Œã†ãŸã‚ã®ç‰¹åˆ¥ãªæ©Ÿèƒ½ã§ã™ã€‚

**ä¸»ãªæ©Ÿèƒ½**:
1. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çŠ¶æ…‹ç®¡ç†**
   - ç¾åœ¨ã®ä¼šè©±å±¥æ­´ï¼ˆmessagesï¼‰ã‚’ä¿æŒ
   - é€ä¿¡ä¸­ã®çŠ¶æ…‹ï¼ˆstatusï¼‰ã‚’ç®¡ç†
   - ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ç®¡ç†

2. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®é€šä¿¡**
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«`POST /api/chat`ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
   - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å—ä¿¡
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

3. **è‡ªå‹•å†é€ä¿¡æ©Ÿèƒ½**
   - ãƒ„ãƒ¼ãƒ«æ‰¿èªå¾Œã®è‡ªå‹•ç¶™ç¶šé€ä¿¡
   - ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å†é–‹æ©Ÿèƒ½

**ã‚³ãƒ¼ãƒ‰ä¾‹**:
```typescript
const {
  messages,        // ä¼šè©±å±¥æ­´
  sendMessage,     // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°
  status,          // é€ä¿¡çŠ¶æ…‹ï¼ˆ"idle", "streaming"ãªã©ï¼‰
  stop,            // é€ä¿¡åœæ­¢é–¢æ•°
} = useChat({
  id: chatId,      // ãƒãƒ£ãƒƒãƒˆID
  api: "/api/chat", // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
});
```

---

### âš™ï¸ BACKEND (Next.js)

#### API Routesï¼ˆAPIãƒ«ãƒ¼ãƒˆï¼‰

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã¯ã€WEB APPã‹ã‚‰ã®æ§˜ã€…ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã€Œçª“å£ã€ãŒè¤‡æ•°ã‚ã‚Šã¾ã™ã€‚

**POST /api/chat**
- **å ´æ‰€**: `app/(chat)/api/chat/route.ts`
- **å½¹å‰²**: ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ã‚’å‡¦ç†ã™ã‚‹æœ€ã‚‚é‡è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **å‡¦ç†å†…å®¹**:
  1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹
  2. èªè¨¼ãƒ»èªå¯ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèªï¼‰
  3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆ1æ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°åˆ¶é™ï¼‰
  4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  5. LLMã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡
  6. LLMã‹ã‚‰ã®å¿œç­”ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å½¢å¼ã§è¿”ã™

**GET /api/history**
- **å½¹å‰²**: éå»ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å–å¾—
- **å‡¦ç†å†…å®¹**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç‰¹å®šã®ãƒãƒ£ãƒƒãƒˆIDã«é–¢é€£ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦è¿”ã™

**POST /api/files/upload**
- **å½¹å‰²**: ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å‡¦ç†
- **å‡¦ç†å†…å®¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã‚Šã€ä¿å­˜ã™ã‚‹

**POST /api/document**
- **å½¹å‰²**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé–¢é€£ã®æ“ä½œã‚’å‡¦ç†
- **å‡¦ç†å†…å®¹**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆã€æ›´æ–°ã€å‰Šé™¤ãªã©

**POST /api/suggestions**
- **å½¹å‰²**: AIã‹ã‚‰ã®ææ¡ˆã‚’ç”Ÿæˆãƒ»å–å¾—
- **å‡¦ç†å†…å®¹**: ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹å–„ææ¡ˆãªã©ã‚’ç”Ÿæˆ

**POST /api/vote**
- **å½¹å‰²**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©•ä¾¡ã‚„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¨˜éŒ²
- **å‡¦ç†å†…å®¹**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã™ã‚‹ã€Œã„ã„ã­ã€ã€Œã‚ˆããªã„ã€ãªã©ã®è©•ä¾¡ã‚’ä¿å­˜

#### Server Actionsï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

APIãƒ«ãƒ¼ãƒˆã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹å…·ä½“çš„ãªå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚

**ä¸»ãªå‡¦ç†**:
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤‰æ›ï¼ˆUIå½¢å¼ â†” ãƒ¢ãƒ‡ãƒ«å½¢å¼ï¼‰
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æº–å‚™
- LLMã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‡¦ç†

#### DB Management & Data Storageï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã¨ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰

**Chat Managementï¼ˆãƒãƒ£ãƒƒãƒˆç®¡ç†ï¼‰**
- **ãƒ†ãƒ¼ãƒ–ãƒ«**: `Chat`ãƒ†ãƒ¼ãƒ–ãƒ«
- **ä¿å­˜å†…å®¹**:
  - ãƒãƒ£ãƒƒãƒˆIDï¼ˆå„ä¼šè©±ã‚’è­˜åˆ¥ã™ã‚‹ä¸€æ„ã®IDï¼‰
  - ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¼šè©±ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰
  - ä½œæˆæ—¥æ™‚
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆèª°ã®ãƒãƒ£ãƒƒãƒˆã‹ï¼‰
  - å…¬é–‹è¨­å®šï¼ˆpublic/privateï¼‰

**Message Managementï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†ï¼‰**
- **ãƒ†ãƒ¼ãƒ–ãƒ«**: `Message_v2`ãƒ†ãƒ¼ãƒ–ãƒ«
- **ä¿å­˜å†…å®¹**:
  - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
  - ãƒãƒ£ãƒƒãƒˆIDï¼ˆã©ã®ä¼šè©±ã«å±ã™ã‚‹ã‹ï¼‰
  - å½¹å‰²ï¼ˆuser/assistantï¼‰
  - ãƒ‘ãƒ¼ãƒ„ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ã‚’æ§‹é€ åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ï¼‰
  - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
  - ä½œæˆæ—¥æ™‚

**DifyWorkflowDsl Managementï¼ˆDifyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼DSLç®¡ç†ï¼‰**
- **ãƒ†ãƒ¼ãƒ–ãƒ«**: `DifyWorkflowDsl`ãƒ†ãƒ¼ãƒ–ãƒ«
- **ä¿å­˜å†…å®¹**:
  - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ID
  - ãƒãƒ£ãƒƒãƒˆID
  - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
  - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
  - YAMLå½¢å¼ã®DSLå®šç¾©
  - ãƒ¢ãƒ¼ãƒ‰ï¼ˆadvanced-chat/workflow/agent-chatï¼‰
  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ä¾‹**:
```typescript
// Chatãƒ†ãƒ¼ãƒ–ãƒ«
{
  id: "uuid",           // ãƒãƒ£ãƒƒãƒˆID
  title: "ä¼šè©±ã®ã‚¿ã‚¤ãƒˆãƒ«",
  userId: "user-uuid",  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  visibility: "private", // å…¬é–‹è¨­å®š
  createdAt: "2026-02-09T..."
}

// Messageãƒ†ãƒ¼ãƒ–ãƒ«
{
  id: "uuid",           // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
  chatId: "chat-uuid",  // ãƒãƒ£ãƒƒãƒˆID
  role: "user",         // "user" ã¾ãŸã¯ "assistant"
  parts: [...],        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ï¼ˆæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼‰
  attachments: [],     // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
  createdAt: "2026-02-09T..."
}
```

#### Utilitiesï¼ˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼‰

**Prompt Managementï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ï¼‰**
- **å ´æ‰€**: `lib/ai/prompts.ts`
- **å½¹å‰²**: AIã«é€ã‚‹ã€ŒæŒ‡ç¤ºæ–‡ã€ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’ç®¡ç†ã—ã¾ã™
- **æ©Ÿèƒ½**:
  - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç”Ÿæˆ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åŸºã¥ã„ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æº–å‚™
  - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã®è¿½åŠ ï¼ˆä½ç½®æƒ…å ±ãªã©ï¼‰

**YAML Generationï¼ˆDify Modeï¼‰ï¼ˆYAMLç”Ÿæˆï¼‰**
- **å ´æ‰€**: `app/(chat)/api/chat/route.ts`å†…ã®`saveDslToTempFile`é–¢æ•°
- **å½¹å‰²**: Difyã‚µãƒ¼ãƒ“ã‚¹ã§ä½¿ç”¨ã™ã‚‹YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™
- **å‡¦ç†å†…å®¹**:
  1. LLMãŒç”Ÿæˆã—ãŸYAMLã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡º
  2. YAMLã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
  3. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã‚’æ¨æ¸¬
  4. `dsl/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
  5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚‚ä¿å­˜

---

### ğŸŒ EXTERNAL SERVICESï¼ˆå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼‰

#### External LLM (Vercel AI Gateway)

**å½¹å‰²**: ä¼šè©±ã®ã€ŒçŸ¥çš„ãªã€éƒ¨åˆ†ã‚’æ‹…ã†AIãƒ¢ãƒ‡ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

**Vercel AI Gatewayã¨ã¯**:
- æ§˜ã€…ãªLLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¸ã®çµ±ä¸€çš„ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã™ã‚‹ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚µãƒ¼ãƒ“ã‚¹
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€ãƒ­ã‚°ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãªã©ã®æ©Ÿèƒ½ã‚’æä¾›
- è¤‡æ•°ã®AIãƒ¢ãƒ‡ãƒ«ã‚’ç°¡å˜ã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹

**åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«**:

1. **xAIãƒ¢ãƒ‡ãƒ«**
   - `grok-2-vision-1212`: ç”»åƒã‚‚ç†è§£ã§ãã‚‹å¤šæ©Ÿèƒ½ãƒ¢ãƒ‡ãƒ«
   - `grok-3-mini`: ã‚ˆã‚Šå°å‹ã§é«˜é€Ÿãªãƒ¢ãƒ‡ãƒ«

2. **OpenAIäº’æ›ãƒ¢ãƒ‡ãƒ«**
   - OpenAIãŒæä¾›ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚„ã€OpenAIäº’æ›ã®APIã‚’æŒã¤ä»–ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ¢ãƒ‡ãƒ«

**ãƒ¢ãƒ‡ãƒ«ã®é¸æŠ**:
- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
- Difyãƒ¢ãƒ¼ãƒ‰: ç’°å¢ƒå¤‰æ•°`AI_DIFY_MODEL`ã§æŒ‡å®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨

#### Dify Serviceï¼ˆDifyã‚µãƒ¼ãƒ“ã‚¹ï¼‰

**å½¹å‰²**: AIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ãƒ»é‹ç”¨ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚

**ç¾åœ¨ã®æ©Ÿèƒ½**:
- YAMLå½¢å¼ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ã®ç”Ÿæˆ
- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ã®ä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼‰

**å°†æ¥ã®æ©Ÿèƒ½ï¼ˆè¨ˆç”»ä¸­ï¼‰**:
- **YAML Deploymentï¼ˆYAMLãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰**: ç”Ÿæˆã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’Difyã‚µãƒ¼ãƒ“ã‚¹ã«å®Ÿéš›ã«å±•é–‹
- **Public URL Retrievalï¼ˆå…¬é–‹URLå–å¾—ï¼‰**: ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸDifyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¬é–‹URLã‚’å–å¾—

---

## ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®æµã‚Œï¼ˆè©³ç´°è§£èª¬ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒƒãƒˆç”»é¢ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã‹ã‚‰ã€AIã‹ã‚‰ã®è¿”ä¿¡ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ã®è©³ç´°ãªæµã‚Œã‚’è§£èª¬ã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›

**å ´æ‰€**: WEB APPã®`Chat`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**å‹•ä½œ**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒƒãƒˆç”»é¢ã®å…¥åŠ›æ¬„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¿ã‚¤ãƒ—
2. ã€Œé€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. `useChat`ãƒ•ãƒƒã‚¯ã®`sendMessage`é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹

**ã‚³ãƒ¼ãƒ‰ä¾‹**:
```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
sendMessage({
  text: "ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã®å¤©æ°—ã¯ï¼Ÿ",
  role: "user"
});
```

---

### ã‚¹ãƒ†ãƒƒãƒ—2: WEB APPãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æº–å‚™

**å ´æ‰€**: `components/chat.tsx`ã®`useChat`ãƒ•ãƒƒã‚¯å†…

**å‹•ä½œ**:
1. `DefaultChatTransport`ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æº–å‚™
2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’ç”Ÿæˆ
3. ç¾åœ¨ã®ä¼šè©±å±¥æ­´ã«æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
4. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ§‹ç¯‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ä¾‹**:
```json
{
  "id": "chat-uuid-123",
  "message": {
    "id": "message-uuid-456",
    "role": "user",
    "parts": [
      {
        "type": "text",
        "text": "ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã®å¤©æ°—ã¯ï¼Ÿ"
      }
    ]
  },
  "selectedChatModel": "xai/grok-2-vision-1212",
  "selectedVisibilityType": "private",
  "systemPromptId": "default"
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—3: POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡

**å ´æ‰€**: WEB APP â†’ BACKEND

**å‹•ä½œ**:
- HTTP POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ`/api/chat`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é€ä¿¡ã•ã‚Œã‚‹
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯èªè¨¼æƒ…å ±ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ãªã©ï¼‰ãŒå«ã¾ã‚Œã‚‹

---

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡

**å ´æ‰€**: `app/(chat)/api/chat/route.ts`ã®`POST`é–¢æ•°

**å‹•ä½œ**:

**4-1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œè¨¼**
```typescript
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦æ¤œè¨¼
requestBody = postRequestBodySchema.parse(requestJson);
```

**4-2. èªè¨¼ãƒã‚§ãƒƒã‚¯**
```typescript
const session = await auth();
if (!session?.user) {
  return new ChatSDKError("unauthorized:chat").toResponse();
}
```
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèª
- ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

**4-3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯**
```typescript
const messageCount = await getMessageCountByUserId({
  id: session.user.id,
  differenceInHours: 24,
});

if (messageCount > maxMessagesPerDay) {
  return new ChatSDKError("rate_limit:chat").toResponse();
}
```
- éå»24æ™‚é–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’ç¢ºèª
- åˆ¶é™ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

**4-4. ãƒãƒ£ãƒƒãƒˆã®ç¢ºèªãƒ»ä½œæˆ**
```typescript
const chat = await getChatById({ id });
if (!chat) {
  // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’ä½œæˆ
  await saveChat({
    id,
    userId: session.user.id,
    title: "New chat",
    visibility: selectedVisibilityType,
  });
}
```

**4-5. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¿å­˜**
```typescript
await saveMessages({
  messages: [{
    chatId: id,
    id: message.id,
    role: "user",
    parts: message.parts,
    attachments: [],
    createdAt: new Date(),
  }],
});
```
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
- ã“ã‚Œã«ã‚ˆã‚Šã€ä¼šè©±å±¥æ­´ãŒæ°¸ç¶šåŒ–ã•ã‚Œã‚‹

---

### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æº–å‚™

**å ´æ‰€**: `lib/ai/prompts.ts`

**å‹•ä½œ**:
1. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
   - é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
   - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆIDã«å¿œã˜ãŸç‰¹åˆ¥ãªæŒ‡ç¤ºï¼ˆä¾‹: Difyãƒ¢ãƒ¼ãƒ‰ï¼‰
   - ä½ç½®æƒ…å ±ãªã©ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è¿½åŠ 

2. ä¼šè©±å±¥æ­´ã‚’ãƒ¢ãƒ‡ãƒ«å½¢å¼ã«å¤‰æ›
   - UIå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã€LLMãŒç†è§£ã§ãã‚‹å½¢å¼ã«å¤‰æ›

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¾‹**:
```
ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "ã‚ãªãŸã¯è¦ªåˆ‡ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚..."

ä¼šè©±å±¥æ­´:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼: "ã“ã‚“ã«ã¡ã¯"
- ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ: "ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
- ãƒ¦ãƒ¼ã‚¶ãƒ¼: "ä»Šæ—¥ã®å¤©æ°—ã¯ï¼Ÿ" â† æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

---

### ã‚¹ãƒ†ãƒƒãƒ—6: LLMã«APIå‘¼ã³å‡ºã—

**å ´æ‰€**: `app/(chat)/api/chat/route.ts`å†…ã®`streamText`é–¢æ•°

**å‹•ä½œ**:

**6-1. streamTexté–¢æ•°ã®å‘¼ã³å‡ºã—**
```typescript
const result = streamText({
  model: getLanguageModel(resolvedChatModel), // ä¾‹: "xai/grok-2-vision-1212"
  system: systemPrompt(...),                  // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
  messages: modelMessages,                    // ä¼šè©±å±¥æ­´
  tools: {...},                               // åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«
});
```

**6-2. LLMã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡**
- Vercel AI Gatewayã‚’é€šã˜ã¦ã€é¸æŠã•ã‚ŒãŸLLMã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ä¼šè©±å±¥æ­´ãŒå«ã¾ã‚Œã‚‹

**6-3. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã®é–‹å§‹**
- LLMã¯å¿œç­”ã‚’å°‘ã—ãšã¤ç”Ÿæˆã—å§‹ã‚ã‚‹
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ãã‚‹

---

### ã‚¹ãƒ†ãƒƒãƒ—7: LLMãŒå¿œç­”ã‚’ç”Ÿæˆ

**å ´æ‰€**: External LLMï¼ˆxAIã€OpenAIãªã©ï¼‰

**å‹•ä½œ**:
1. LLMãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ä¼šè©±å±¥æ­´ã‚’å‡¦ç†
2. é©åˆ‡ãªå¿œç­”ã‚’ç”Ÿæˆï¼ˆä¾‹: "ä»Šæ—¥ã®å¤©æ°—ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™..."ï¼‰
3. å¿œç­”ã‚’ãƒˆãƒ¼ã‚¯ãƒ³å˜ä½ã§å°‘ã—ãšã¤è¿”ã™ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰

**ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®ä»•çµ„ã¿**:
- é€šå¸¸ã®APIå‘¼ã³å‡ºã—: å¿œç­”å…¨ä½“ãŒå®Œæˆã—ã¦ã‹ã‚‰è¿”ã•ã‚Œã‚‹
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°: å¿œç­”ã‚’ç”Ÿæˆã—ãªãŒã‚‰ã€å®Œæˆã—ãŸéƒ¨åˆ†ã‹ã‚‰é †ã«è¿”ã™
- ãƒ¡ãƒªãƒƒãƒˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¾…ãŸãšã«ã€AIãŒè€ƒãˆãªãŒã‚‰å¿œç­”ã—ã¦ã„ã‚‹æ§˜å­ã‚’è¦‹ã‚‰ã‚Œã‚‹

---

### ã‚¹ãƒ†ãƒƒãƒ—8: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’å‡¦ç†

**å ´æ‰€**: `app/(chat)/api/chat/route.ts`å†…ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†

**å‹•ä½œ**:

**8-1. ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ä½œæˆ**
```typescript
const stream = createUIMessageStream({
  execute: async ({ writer: dataStream }) => {
    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
  }
});
```

**8-2. å¿œç­”ã®å‡¦ç†**
- LLMã‹ã‚‰ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
- ãƒ‡ãƒ¼ã‚¿ã‚’UIå½¢å¼ã«å¤‰æ›
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§WEB APPã«é€ä¿¡

**8-3. å®Œäº†æ™‚ã®å‡¦ç†ï¼ˆonFinishï¼‰**
```typescript
onFinish: async ({ text }) => {
  // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  await saveMessages({
    messages: [{
      chatId: id,
      id: assistantMessageId,
      role: "assistant",
      parts: [...],
      createdAt: new Date(),
    }],
  });

  // Difyãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€YAMLã‚’æŠ½å‡ºã—ã¦ä¿å­˜
  if (isDifyMode) {
    const yaml = extractYamlCodeBlock(text);
    if (yaml && isValidDsl(yaml)) {
      await saveDslToTempFile({ chatId, dslYaml: yaml });
      await saveDifyWorkflowDsl({ chatId, dslYaml: yaml, ... });
    }
  }
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—9: WEB APPãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’å—ä¿¡

**å ´æ‰€**: `components/chat.tsx`ã®`useChat`ãƒ•ãƒƒã‚¯

**å‹•ä½œ**:

**9-1. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡**
```typescript
onData: (dataPart) => {
  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡
  setDataStream((ds) => (ds ? [...ds, dataPart] : []));
}
```

**9-2. UIã®æ›´æ–°**
- å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’`messages`çŠ¶æ…‹ã«è¿½åŠ 
- Reactã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ã‚ˆã‚Šã€ç”»é¢ãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€AIãŒã‚¿ã‚¤ãƒ—ã—ã¦ã„ã‚‹ã‚ˆã†ã«æ–‡å­—ãŒå¾ã€…ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã‚’è¦‹ã‚‹

**9-3. å®Œäº†æ™‚ã®å‡¦ç†**
```typescript
onFinish: () => {
  // ä¼šè©±å±¥æ­´ã‚’æ›´æ–°
  mutate(unstable_serialize(getChatHistoryPaginationKey));
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—10: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿œç­”ã‚’ç¢ºèª

**å ´æ‰€**: WEB APPã®`Chat`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**å‹•ä½œ**:
- AIã‹ã‚‰ã®å¿œç­”ãŒç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç¶šã‘ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã‚‹
- ä¼šè©±å±¥æ­´ã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹

---

## ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨ç®¡ç†

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ§‹é€ 

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã—ã¦ã„ã¾ã™ã€‚

#### ä¸»è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«

**1. Userï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰**
```typescript
{
  id: "uuid",              // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  email: "user@example.com",
  password: "hashed-password"
}
```

**2. Chatï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰**
```typescript
{
  id: "uuid",              // ãƒãƒ£ãƒƒãƒˆID
  userId: "uuid",          // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰
  title: "ä¼šè©±ã®ã‚¿ã‚¤ãƒˆãƒ«",
  visibility: "private",  // "public" ã¾ãŸã¯ "private"
  createdAt: "2026-02-09T..."
}
```

**3. Message_v2ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰**
```typescript
{
  id: "uuid",              // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
  chatId: "uuid",          // ãƒãƒ£ãƒƒãƒˆIDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰
  role: "user",            // "user" ã¾ãŸã¯ "assistant"
  parts: [                 // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ï¼ˆæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼‰
    {
      type: "text",
      text: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹"
    }
  ],
  attachments: [],        // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
  createdAt: "2026-02-09T..."
}
```

**4. DifyWorkflowDslï¼ˆDifyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼DSLï¼‰**
```typescript
{
  id: "uuid",
  chatId: "uuid",
  messageId: "uuid",       // é–¢é€£ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
  userId: "uuid",
  workflowName: "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å",
  mode: "advanced-chat",   // "advanced-chat" | "workflow" | "agent-chat"
  dslYaml: "yamlå½¢å¼ã®å®šç¾©",
  version: 1,
  createdAt: "2026-02-09T..."
}
```

### ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**:
- é€ä¿¡ç›´å¾Œã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹
- LLMã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰ã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¤±ã‚ã‚Œãªã„

**ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**:
- LLMã‹ã‚‰ã®å¿œç­”ãŒå®Œäº†ã—ãŸæ™‚ç‚¹ã§ä¿å­˜ã•ã‚Œã‚‹
- `onFinish`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§ä¿å­˜å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹

**Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼DSL**:
- Difyãƒ¢ãƒ¼ãƒ‰ã§LLMãŒYAMLã‚’ç”Ÿæˆã—ãŸå ´åˆã«ä¿å­˜ã•ã‚Œã‚‹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ä¸¡æ–¹ã«ä¿å­˜ã•ã‚Œã‚‹

---

## Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã®é€£æº

### Difyãƒ¢ãƒ¼ãƒ‰ã¨ã¯

**Difyãƒ¢ãƒ¼ãƒ‰**: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆIDãŒ`"dify-rule-ver5"`ã®å ´åˆã«æœ‰åŠ¹ã«ãªã‚‹ç‰¹åˆ¥ãªãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚

**ç‰¹å¾´**:
- LLMãŒDifyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®YAMLå®šç¾©ã‚’ç”Ÿæˆã™ã‚‹
- ç”Ÿæˆã•ã‚ŒãŸYAMLã¯è‡ªå‹•çš„ã«æŠ½å‡ºãƒ»æ¤œè¨¼ãƒ»ä¿å­˜ã•ã‚Œã‚‹
- å°†æ¥çš„ã«Difyã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹å½¢å¼ã§ä¿å­˜ã•ã‚Œã‚‹

### YAMLç”Ÿæˆã®æµã‚Œ

**1. LLMãŒYAMLã‚’ç”Ÿæˆ**
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "é–¢è¥¿å¼ã«å¤‰æ›ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ã¦"

ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ: 
```yaml
app:
  name: é–¢è¥¿å¼ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼
  ...
workflow:
  graph:
    nodes:
    ...
```
```

**2. YAMLã®æŠ½å‡º**
```typescript
const extractYamlCodeBlock = (text: string): string | null => {
  const matches = [...text.matchAll(/```(?:ya?ml)?\s*([\s\S]*?)```/gi)];
  const last = matches.at(-1);
  return last?.[1]?.trim() ?? null;
};
```

**3. YAMLã®æ¤œè¨¼**
```typescript
const isValidDsl = (yaml: string): boolean => {
  // æœ€ä½10è¡Œä»¥ä¸Šã‚ã‚‹ã‹
  if (yaml.split("\n").length < 10) return false;
  
  // app: ã¾ãŸã¯ kind: app ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
  const hasAppOrKind = /^\s*(app:|kind:\s*app)/m.test(yaml);
  
  // workflow: ã¾ãŸã¯ graph: ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
  const hasWorkflowOrGraph = /workflow:/m.test(yaml) || /graph:/m.test(yaml);
  
  return hasAppOrKind && hasWorkflowOrGraph;
};
```

**4. ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜**
```typescript
const filename = `${workflowName}_${chatId}_${timestamp}.yml`;
const filePath = join(dslDir, filename);
await writeFile(filePath, dslYaml, "utf8");
```
- `dsl/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ«å: `{ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å}_{ãƒãƒ£ãƒƒãƒˆID}_{ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—}.yml`

**5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜**
```typescript
await saveDifyWorkflowDsl({
  chatId,
  userId: session.user.id,
  messageId: assistantMessageId,
  dslYaml: yaml,
  workflowName: inferredName,
  mode: "advanced-chat",
});
```

### ä¿å­˜ã•ã‚Œã‚‹YAMLã®ä¾‹

å®Ÿéš›ã«ä¿å­˜ã•ã‚Œã‚‹YAMLãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹ï¼ˆ`dsl/__________bf306072-163d-4a81-b0ea-4b7f2fd50258_2026-02-05T06-51-06-659Z.yml`ï¼‰:

```yaml
app:
  description: å…¥åŠ›ã•ã‚ŒãŸæ—¥æœ¬èªã‚’ã€ã§ãã‚‹ã ã‘è‡ªç„¶ãªé–¢è¥¿å¼ã«å¤‰æ›ã—ã¦è¿”ã—ã¾ã™
  icon: ğŸ—£ï¸
  icon_background: '#FFCC00'
  mode: advanced-chat
  name: é–¢è¥¿å¼ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼
kind: app
version: 0.1.5
workflow:
  features:
    file_upload:
      enabled: false
    opening_statement: ''
    suggested_questions: []
  graph:
    edges:
    - id: start-llm_kansai
      source: start
      target: llm_kansai
    nodes:
    - id: start
      type: start
    - id: llm_kansai
      type: llm
      data:
        prompt_template:
        - role: system
          text: |
            ã‚ãªãŸã¯ã€Œé–¢è¥¿å¼å¤‰æ›ã€ã®ãƒ—ãƒ­ã§ã™...
        - role: user
          text: '{{#sys.query#}}'
    - id: answer
      type: answer
      data:
        answer: '{{#llm_kansai.text#}}'
```

---

## æŠ€è¡“çš„ãªè©³ç´°

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®ä»•çµ„ã¿

**Server-Sent Events (SSE)**
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¸ã®ä¸€æ–¹å‘é€šä¿¡ã«ä½¿ç”¨
- HTTPæ¥ç¶šã‚’ç¶­æŒã—ãŸã¾ã¾ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç¶™ç¶šçš„ã«é€ä¿¡ã§ãã‚‹
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã«é©ã—ã¦ã„ã‚‹

**ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®æµã‚Œ**:
```
LLM â†’ Backend â†’ SSE Stream â†’ Frontend â†’ UIæ›´æ–°
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**èªè¨¼ã‚¨ãƒ©ãƒ¼**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆ: `401 Unauthorized`
- ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ãŸå ´åˆ: `403 Forbidden`

**ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼**
- 1æ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°åˆ¶é™ã‚’è¶…ãˆãŸå ´åˆ: `429 Too Many Requests`

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼**
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å½¢å¼ãŒä¸æ­£ãªå ´åˆ: `400 Bad Request`

**ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤º**
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§`toast`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**èªè¨¼**
- Next.jsã®`auth()`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- å„APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª

**èªå¯**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒãƒ£ãƒƒãƒˆã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç¢ºèª

**å…¥åŠ›æ¤œè¨¼**
- Zodã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ¤œè¨¼
- ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã‚’æ‹’å¦

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

**ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**
- å¿œç­”ã‚’å¾…ãŸãšã«ã€ç”Ÿæˆã•ã‚ŒãŸéƒ¨åˆ†ã‹ã‚‰é †ã«è¡¨ç¤º
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–**
- å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–å¾—
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã—ã¦é«˜é€ŸåŒ–

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥**
- ä¼šè©±å±¥æ­´ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆSWRã‚’ä½¿ç”¨ï¼‰
- ä¸è¦ãªå†å–å¾—ã‚’é˜²æ­¢

---

## ã¾ã¨ã‚

ã“ã®AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§å‹•ä½œã—ã¦ã„ã¾ã™ï¼š

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡** â†’ WEB APP
2. **ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†** â†’ BACKEND
3. **ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜** â†’ DATABASE
4. **AIã«å•ã„åˆã‚ã›** â†’ EXTERNAL LLM
5. **å¿œç­”ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°** â†’ BACKEND â†’ WEB APP
6. **ç”»é¢ã«è¡¨ç¤º** â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèª

å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒé©åˆ‡ã«é€£æºã™ã‚‹ã“ã¨ã§ã€ã‚¹ãƒ ãƒ¼ã‚ºãªãƒãƒ£ãƒƒãƒˆä½“é¨“ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€Difyãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã€AIãŒç”Ÿæˆã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ã‚’è‡ªå‹•çš„ã«ä¿å­˜ã—ã€å°†æ¥çš„ã«Difyã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹æº–å‚™ã‚‚æ•´ãˆã¦ã„ã¾ã™ã€‚

---

## å‚è€ƒè³‡æ–™

- [Next.jså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://nextjs.org/docs)
- [Reactå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://react.dev)
- [Vercel AI SDK](https://sdk.vercel.ai/docs)
- [Difyå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.dify.ai)
