app:
  description: å…¥åŠ›æ–‡ç« ã‚’æ„å›³åˆ†é¡ãƒ»æ„Ÿæƒ…åˆ†æãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã—ã€å¿…è¦ã«å¿œã˜ã¦è¦ç´„ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆåŒ–ã€å‰å›å…¥åŠ›ã¨æ¯”è¼ƒã™ã‚‹
  icon: ğŸ§ 
  icon_background: '#4F46E5'
  mode: advanced-chat
  name: ãƒ†ã‚­ã‚¹ãƒˆåˆ†æãƒ¬ãƒãƒ¼ã‚¿ãƒ¼
kind: app
version: 0.1.5
workflow:
  features:
    file_upload:
      enabled: false
    opening_statement: ''
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    text_to_speech:
      enabled: false
  graph:
    edges:
      - data:
          isInIteration: false
          isInLoop: false
          sourceType: start
          targetType: llm
        id: start-llm_analyze
        source: start
        sourceHandle: source
        target: llm_analyze
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          isInLoop: false
          sourceType: llm
          targetType: code
        id: llm_analyze-code_parse
        source: llm_analyze
        sourceHandle: source
        target: code_parse
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          isInLoop: false
          sourceType: code
          targetType: if-else
        id: code_parse-if_summary
        source: code_parse
        sourceHandle: source
        target: if_summary
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          isInLoop: false
          sourceType: if-else
          targetType: llm
        id: if_summary-true-llm_summary
        source: if_summary
        sourceHandle: 'true'
        target: llm_summary
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          isInLoop: false
          sourceType: if-else
          targetType: code
        id: if_summary-false-code_no_summary
        source: if_summary
        sourceHandle: 'false'
        target: code_no_summary
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          isInLoop: false
          sourceType: llm
          targetType: code
        id: llm_summary-code_build_report
        source: llm_summary
        sourceHandle: source
        target: code_build_report
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          isInLoop: false
          sourceType: code
          targetType: code
        id: code_no_summary-code_build_report
        source: code_no_summary
        sourceHandle: source
        target: code_build_report
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          isInLoop: false
          sourceType: code
          targetType: answer
        id: code_build_report-answer
        source: code_build_report
        sourceHandle: source
        target: answer
        targetHandle: target
        type: custom
        zIndex: 0
    nodes:
      - data:
          desc: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆsys.queryï¼‰ã‚’å—ã‘å–ã‚‹
          selected: false
          title: Start
          type: start
          variables: []
        height: 98
        id: start
        position:
          x: -520
          y: 240
        positionAbsolute:
          x: -520
          y: 240
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244
      - data:
          context:
            enabled: false
            variable_selector: []
          desc: æ„å›³åˆ†é¡ãƒ»æ„Ÿæƒ…åˆ†æãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã‚’ä¸€æ‹¬ã§JSONå‡ºåŠ›
          model:
            completion_params:
              frequency_penalty: 0
              max_tokens: 900
              presence_penalty: 0
              temperature: 0.2
              top_p: 1
            mode: chat
            name: gpt-4o
            provider: openai
          prompt_template:
            - id: system
              role: system
              text: |
                ã‚ãªãŸã¯æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆåˆ†æå™¨ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›æ–‡ç« ã‚’ä»¥ä¸‹ã®å½¢å¼ã®ã€Œå³å¯†ãªJSONã®ã¿ã€ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆå‰å¾Œã«èª¬æ˜æ–‡ã‚’ä»˜ã‘ãªã„ï¼‰ã€‚

                # åˆ†é¡ãƒ©ãƒ™ãƒ«ï¼ˆintentï¼‰
                question / request / complaint / feedback / idea / chitchat / other

                # sentiment
                - label: positive / neutral / negative
                - score: -1.0ã€œ1.0 ã®å°æ•°ï¼ˆãƒã‚¬ã»ã©-ã€ãƒã‚¸ã»ã©+ï¼‰

                # keywords
                - ä¸Šä½8å€‹
                - 1ã€œ3èªã®ãƒ•ãƒ¬ãƒ¼ã‚ºå¯
                - é‡è¤‡ã‚„è¡¨è¨˜ã‚†ã‚Œã¯ã§ãã‚‹ã ã‘çµ±ä¸€
                - å…·ä½“åè©ã‚’å„ªå…ˆ

                # å‡ºåŠ›JSONã‚¹ã‚­ãƒ¼ãƒ
                {
                  "intent": "question",
                  "sentiment": { "label": "neutral", "score": 0.0 },
                  "keywords": ["...", "..."],
                  "needs_summary": true,
                  "reason_needs_summary": "..."
                }

                needs_summary ã®åˆ¤å®šãƒ«ãƒ¼ãƒ«:
                - å…¥åŠ›ãŒ400æ–‡å­—ä»¥ä¸Šãªã‚‰ true
                - ãã‚Œä»¥å¤–ã¯ false
          selected: false
          title: åˆ†æï¼ˆåˆ†é¡/æ„Ÿæƒ…/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰/è¦ç´„è¦å¦ï¼‰
          type: llm
        height: 168
        id: llm_analyze
        position:
          x: -220
          y: 240
        positionAbsolute:
          x: -220
          y: 240
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 360
      - data:
          code: |
            import json

            def main(text: str) -> dict:
                """
                LLMã®JSONãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€ä»¥é™ã®ãƒãƒ¼ãƒ‰ã§æ‰±ã„ã‚„ã™ã„å½¢ã«æ•´å½¢ã™ã‚‹ã€‚
                """
                raw = (text or "").strip()

                # å¿µã®ãŸã‚ã€å‰å¾Œã«ä½™è¨ˆãªæ–‡å­—ãŒæ··ã–ã£ãŸã‚±ãƒ¼ã‚¹ã‚‚æ¥µåŠ›æ•‘æ¸ˆ
                start = raw.find("{")
                end = raw.rfind("}")
                if start != -1 and end != -1 and end > start:
                    raw_json = raw[start:end+1]
                else:
                    raw_json = raw

                data = json.loads(raw_json)

                intent = data.get("intent", "other")
                sentiment = data.get("sentiment", {}) or {}
                s_label = sentiment.get("label", "neutral")
                s_score = sentiment.get("score", 0.0)

                keywords = data.get("keywords", []) or []
                keywords = [str(k).strip() for k in keywords if str(k).strip()]

                needs_summary = bool(data.get("needs_summary", False))
                reason = data.get("reason_needs_summary", "")

                return {
                    "intent": intent,
                    "sentiment_label": s_label,
                    "sentiment_score": float(s_score) if s_score is not None else 0.0,
                    "keywords": keywords,
                    "needs_summary": needs_summary,
                    "reason_needs_summary": reason,
                    "analysis_raw": data
                }
          code_language: python3
          desc: LLMå‡ºåŠ›JSONã‚’ãƒ‘ãƒ¼ã‚¹
          outputs:
            analysis_raw:
              children: null
              type: object
            intent:
              children: null
              type: string
            keywords:
              children: null
              type: array[string]
            needs_summary:
              children: null
              type: boolean
            reason_needs_summary:
              children: null
              type: string
            sentiment_label:
              children: null
              type: string
            sentiment_score:
              children: null
              type: number
          selected: false
          title: è§£æçµæœãƒ‘ãƒ¼ã‚¹
          type: code
          variables:
            - value_selector:
                - llm_analyze
                - text
              variable: text
        height: 186
        id: code_parse
        position:
          x: 200
          y: 240
        positionAbsolute:
          x: 200
          y: 240
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 360
      - data:
          cases:
            - case_id: 'true'
              conditions:
                - comparison_operator: is
                  value: 'true'
                  varType: string
                  variable_selector:
                    - code_parse
                    - needs_summary
          desc: needs_summary=true ã®å ´åˆã®ã¿è¦ç´„ã‚’ç”Ÿæˆ
          selected: false
          title: è¦ç´„ãŒå¿…è¦ï¼Ÿ
          type: if-else
        height: 154
        id: if_summary
        position:
          x: 630
          y: 240
        positionAbsolute:
          x: 630
          y: 240
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 280
      - data:
          context:
            enabled: false
            variable_selector: []
          desc: å…¥åŠ›æ–‡ç« ã®è¦ç´„ã‚’ä½œæˆ
          model:
            completion_params:
              frequency_penalty: 0
              max_tokens: 450
              presence_penalty: 0
              temperature: 0.3
              top_p: 1
            mode: chat
            name: gpt-4o
            provider: openai
          prompt_template:
            - id: system
              role: system
              text: |
                ã‚ãªãŸã¯æ—¥æœ¬èªè¦ç´„ã®å°‚é–€å®¶ã§ã™ã€‚ä¸ãˆã‚‰ã‚ŒãŸæ–‡ç« ã‚’ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚
                - 5ã€œ7è¡Œç¨‹åº¦
                - ç®‡æ¡æ›¸ã
                - ä¸»å¼µ/äº‹å®Ÿ/ä¾é ¼äº‹é …ãŒã‚ã‚Œã°å„ªå…ˆã—ã¦æŠ½å‡º
            - id: user
              role: user
              text: |
                æ¬¡ã®æ–‡ç« ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚

                ---æœ¬æ–‡---
                {{#sys.query#}}
          selected: false
          title: è¦ç´„ç”Ÿæˆ
          type: llm
        height: 168
        id: llm_summary
        position:
          x: 970
          y: 160
        positionAbsolute:
          x: 970
          y: 160
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 360
      - data:
          code: |
            def main() -> dict:
                return {
                    "summary": "ï¼ˆçŸ­æ–‡ã®ãŸã‚è¦ç´„ã‚’çœç•¥ã—ã¾ã—ãŸï¼‰"
                }
          code_language: python3
          desc: è¦ç´„ãªã—åˆ†å²ã®ãƒ€ãƒŸãƒ¼è¦ç´„æ–‡
          outputs:
            summary:
              children: null
              type: string
          selected: false
          title: è¦ç´„çœç•¥
          type: code
          variables: []
        height: 140
        id: code_no_summary
        position:
          x: 970
          y: 340
        positionAbsolute:
          x: 970
          y: 340
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 360
      - data:
          code: |
            def _fmt_keywords(words: list) -> str:
                if not words:
                    return "ï¼ˆãªã—ï¼‰"
                return ", ".join(words)

            def _diff_keywords(prev: list, cur: list) -> dict:
                prev_set = set([str(x) for x in (prev or []) if str(x).strip()])
                cur_set = set([str(x) for x in (cur or []) if str(x).strip()])
                added = sorted(list(cur_set - prev_set))
                removed = sorted(list(prev_set - cur_set))
                common = sorted(list(prev_set & cur_set))
                return {"added": added, "removed": removed, "common": common}

            def main(intent: str,
                     sentiment_label: str,
                     sentiment_score: float,
                     keywords: list,
                     needs_summary: bool,
                     reason_needs_summary: str,
                     summary_from_llm: str,
                     summary_from_dummy: str,
                     current_text: str,
                     prev_text: str) -> dict:
                # summaryã¯åˆ†å²ã®ã©ã¡ã‚‰ã‹ãŒæ¥ã‚‹
                summary = summary_from_llm or summary_from_dummy or ""

                # å‰å›æ¯”è¼ƒï¼ˆåŒä¸€ãƒãƒ£ãƒƒãƒˆå†…ã®ç›´å‰æƒ³å®šï¼‰
                has_prev = bool((prev_text or "").strip())
                diff_note = "ï¼ˆå‰å›å…¥åŠ›ãŒãªã„ãŸã‚æ¯”è¼ƒã‚’çœç•¥ï¼‰"
                prev_keywords = []
                prev_intent = None
                prev_sentiment_score = None
                prev_sentiment_label = None

                # ã“ã“ã§ã¯ã€Œå‰å›åˆ†æçµæœã€ã‚’æ°¸ç¶šä¿æŒã§ããªã„ãŸã‚ã€
                # å‰å›ãƒ†ã‚­ã‚¹ãƒˆã¨ã®å·®åˆ†ã¯ç°¡æ˜“ï¼ˆæ–‡å­—æ•°å·®ï¼‰+ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å·®åˆ†ã¯"å‰å›ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç„¡ã„"ã¨ã—ã¦æ‰±ã†ã€‚
                # â€»é«˜åº¦ãªæ¯”è¼ƒãŒå¿…è¦ãªã‚‰ã€å‰å›çµæœJSONã‚’ä¼šè©±å†…ã§ä¿æŒã™ã‚‹è¨­è¨ˆã«æ‹¡å¼µå¯èƒ½ã€‚
                if has_prev:
                    diff_note = f"- æ–‡å­—æ•°: å‰å› {len(prev_text)} â†’ ä»Šå› {len(current_text)}ï¼ˆå·® {len(current_text) - len(prev_text)}ï¼‰"

                kw_diff = _diff_keywords(prev_keywords, keywords)

                report = []
                report.append("# ãƒ†ã‚­ã‚¹ãƒˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆ")
                report.append("")
                report.append("## å…¥åŠ›æ¦‚è¦")
                report.append(f"- æ–‡å­—æ•°: {len(current_text)}")
                report.append(f"- è¦ç´„ç”Ÿæˆ: {'ã‚ã‚Š' if needs_summary else 'ãªã—'}")
                if reason_needs_summary:
                    report.append(f"- åˆ¤å®šç†ç”±: {reason_needs_summary}")
                report.append("")
                report.append("## â‘  æ„å›³åˆ†é¡")
                report.append(f"- intent: **{intent}**")
                report.append("")
                report.append("## â‘¡ æ„Ÿæƒ…åˆ†æ")
                report.append(f"- label: **{sentiment_label}**")
                report.append(f"- score: **{sentiment_score:.2f}**ï¼ˆ-1.0:å¼·ã„ãƒã‚¬ / +1.0:å¼·ã„ãƒã‚¸ï¼‰")
                report.append("")
                report.append("## â‘¢ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¸Šä½ï¼‰")
                report.append(f"- {_fmt_keywords(keywords)}")
                report.append("")
                report.append("## â‘£ è¦ç´„")
                report.append(summary)
                report.append("")
                report.append("## â‘¥ å‰å›å…¥åŠ›ã¨ã®æ¯”è¼ƒï¼ˆåŒä¸€ãƒãƒ£ãƒƒãƒˆå†…ï¼‰")
                report.append(diff_note)
                report.append("")
                report.append("### ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å·®åˆ†ï¼ˆå‚è€ƒï¼‰")
                report.append(f"- è¿½åŠ : {_fmt_keywords(kw_diff['added'])}")
                report.append(f"- æ¶ˆå¤±: {_fmt_keywords(kw_diff['removed'])}")
                report.append(f"- å…±é€š: {_fmt_keywords(kw_diff['common'])}")
                report.append("")
                report.append("---")
                report.append("### ãƒ­ã‚°ï¼ˆä¼šè©±å†…ï¼‰")
                report.append("- ã“ã®ãƒ•ãƒ­ãƒ¼ã¯å¤–éƒ¨ä¿å­˜ãªã—ã®ãŸã‚ã€æ¯”è¼ƒã¯åŒä¸€ãƒãƒ£ãƒƒãƒˆå†…ã®å‰å›å…¥åŠ›ã‚’å‰æã«ã—ã¦ã„ã¾ã™ã€‚")
                report_text = "\n".join(report)

                # ã€Œæ¬¡å›æ¯”è¼ƒç”¨ãƒ­ã‚°ã€ã¨ã—ã¦ã€ä»Šå›ã®å…¥åŠ›ã‚’è¿”ã™ï¼ˆä¼šè©±ãƒ¡ãƒ¢ãƒª/å¤‰æ•°ã¨ã—ã¦ä¿æŒã•ã‚Œã‚‹æƒ³å®šï¼‰
                return {
                    "report": report_text,
                    "log_text": current_text
                }
          code_language: python3
          desc: ãƒ¬ãƒãƒ¼ãƒˆã‚’Markdownã§ç”Ÿæˆã—ã€æ¬¡å›æ¯”è¼ƒç”¨ã«ä»Šå›ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ­ã‚°ã¨ã—ã¦è¿”ã™
          outputs:
            log_text:
              children: null
              type: string
            report:
              children: null
              type: string
          selected: false
          title: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ»ãƒ­ã‚°æ›´æ–°
          type: code
          variables:
            - value_selector:
                - code_parse
                - intent
              variable: intent
            - value_selector:
                - code_parse
                - sentiment_label
              variable: sentiment_label
            - value_selector:
                - code_parse
                - sentiment_score
              variable: sentiment_score
            - value_selector:
                - code_parse
                - keywords
              variable: keywords
            - value_selector:
                - code_parse
                - needs_summary
              variable: needs_summary
            - value_selector:
                - code_parse
                - reason_needs_summary
              variable: reason_needs_summary
            - value_selector:
                - llm_summary
                - text
              variable: summary_from_llm
            - value_selector:
                - code_no_summary
                - summary
              variable: summary_from_dummy
            - value_selector:
                - start
                - sys.query
              variable: current_text
            - value_selector:
                - sys
                - conversation.last_user_message
              variable: prev_text
        height: 210
        id: code_build_report
        position:
          x: 1370
          y: 240
        positionAbsolute:
          x: 1370
          y: 240
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 420
      - data:
          answer: '{{#code_build_report.report#}}'
          desc: ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
          selected: false
          title: Answer
          type: answer
        height: 122
        id: answer
        position:
          x: 1860
          y: 240
        positionAbsolute:
          x: 1860
          y: 240
        selected: false
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 244